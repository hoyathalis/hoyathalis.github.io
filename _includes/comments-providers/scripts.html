<script>
(function() {
  'use strict';
  
  document.addEventListener('DOMContentLoaded', function() {
    const level = 'info';      
    const logSheetUrl = 'https://log-api.newrelic.com/log/v1?Api-Key=5229e7f7b5ce83cbdaec27036f5e52f5FFFFNRAL';

    console.log("DOM fully loaded. Starting log process...");

    // Function to get IP-based location info
    function getVisitorLocation() {
      console.log("Fetching visitor location...");
      return fetch('https://ipinfo.io/json')
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Failed to fetch IP geolocation data');
          }
          return response.json();
        })
        .then(function(data) {
          console.log("Visitor location data fetched successfully:", data);
          return data;
        })
        .catch(function(error) {
          console.error('Error fetching IP geolocation:', error);
          return null;
        });
    }

    // Gather minimal visit metadata
    function getVisitorMetadata() {
      const nav = typeof navigator !== 'undefined' ? navigator : {};
      const tz = (typeof Intl !== 'undefined' && Intl.DateTimeFormat) ? Intl.DateTimeFormat().resolvedOptions().timeZone : undefined;

      // Stable anonymous IDs
      let visitorId = 'visitor';
      try {
        visitorId = localStorage.getItem('visitorId');
        if (!visitorId) {
          visitorId = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + '-' + Math.random().toString(36).slice(2));
          localStorage.setItem('visitorId', visitorId);
        }
      } catch (e) {
        visitorId = 'visitor';
      }

      const dnt = (nav.doNotTrack === '1' || window.doNotTrack === '1' || nav.msDoNotTrack === '1');

      return {
        referrer: document.referrer,
        timezone: tz,
        dnt: dnt,
        visitorId: visitorId
      };
    }

    function getUtmParams() {
      try {
        const params = new URLSearchParams(window.location.search);
        return {
          utm_source: params.get('utm_source') || undefined,
          utm_medium: params.get('utm_medium') || undefined,
          utm_campaign: params.get('utm_campaign') || undefined,
          utm_term: params.get('utm_term') || undefined,
          utm_content: params.get('utm_content') || undefined
        };
      } catch (e) {
        return {};
      }
    }

    function determineTrafficSource(referrer, utm) {
      try {
        if (utm.utm_source) return 'campaign';
        if (!referrer) return 'direct';
        const url = new URL(referrer);
        const host = url.hostname || '';
        const social = ['twitter.com','x.com','linkedin.com','facebook.com','instagram.com','t.co','reddit.com'];
        if (/(google|bing|yahoo|duckduckgo)\./.test(host)) return 'organic';
        if (social.some(function(d) { return host.endsWith(d); })) return 'social';
        return 'referral';
      } catch (e) {
        return 'direct';
      }
    }

    // Log entry with geolocation
    function logPortfolioVisit(level) {
      const metadata = getVisitorMetadata();
      if (metadata.dnt) {
        console.warn('Do Not Track enabled; skipping visit logging');
        return;
      }
      
      const userid = metadata.visitorId;
      console.log('Logging portfolio visit for user: ' + userid + '...');
      
      getVisitorLocation().then(function(locationInfo) {
        const utm = getUtmParams();
        const trafficSource = determineTrafficSource(metadata.referrer, utm);
        const logEntry = {
          "common": {
            "attributes": {
              "logtype": "portfolio-logs",
              "service": "portfolio-service",
              "hostname": window.location.hostname
            }
          },
          "logs": [{
            "timestamp": new Date().toISOString(),
            "message": "User '" + userid + "' visited the portfolio",
            "attributes": {
              "level": level,
              "userid": userid,
              "page": window.location.href,
              "ip": locationInfo && locationInfo.ip,
              "city": locationInfo && locationInfo.city,
              "region": locationInfo && locationInfo.region,
              "country": locationInfo && locationInfo.country,
              "loc": locationInfo && locationInfo.loc,
              "org": locationInfo && locationInfo.org,
              "postal": locationInfo && locationInfo.postal,
              "timezone_ip": locationInfo && locationInfo.timezone,
              "referrer": metadata.referrer,
              "timezone": metadata.timezone,
              "traffic_source": trafficSource,
              "visitorId": metadata.visitorId,
              "utm_source": utm.utm_source,
              "utm_medium": utm.utm_medium,
              "utm_campaign": utm.utm_campaign,
              "utm_term": utm.utm_term,
              "utm_content": utm.utm_content
            }
          }]
        };

        console.log("Log entry prepared:", logEntry);

        return fetch(logSheetUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(logEntry)
        });
      }).then(function(response) {
        if (!response.ok) {
          throw new Error('Failed to log portfolio visit');
        }
        console.log('Portfolio visit logged successfully');
      }).catch(function(error) {
        console.error('Error logging portfolio visit:', error);
      });
    }

    // Call the log function to log the visit
    logPortfolioVisit(level);
  });
})();
</script>

{% if site.comments.provider and page.comments %}
  {% case site.comments.provider %}
    {% when "disqus" %}
      {% include /comments-providers/disqus.html %}
    {% when "discourse" %}
      {% include /comments-providers/discourse.html %}
    {% when "facebook" %}
      {% include /comments-providers/facebook.html %}
    {% when "google-plus" %}
      {% include /comments-providers/google-plus.html %}
    {% when "staticman" %}
      {% include /comments-providers/staticman.html %}
    {% when "custom" %}
      {% include /comments-providers/custom.html %}
  {% endcase %}
{% endif %}
